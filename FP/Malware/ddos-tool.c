#include <pthread.h>
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <arpa/inet.h>
#include <netdb.h>

#define MAX_THREADS 10  // Limit concurrent connections
#define HTTP_PORT 80
#define MAX_BUFFER 1024
#define REQUEST "HEAD / HTTP/1.1\r\nHost: %s\r\nUser-Agent: %s\r\nConnection: close\r\n\r\n"

const char *user_agents[] = {
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
    "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)",
    "Mozilla/5.0 (Linux; Android 10)",
    "Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X)",
};

void *http_request(void *arg) {
    char *server_host = (char *)arg;
    struct sockaddr_in server_addr;
    struct hostent *host_info;
    char request_buffer[MAX_BUFFER];
    char response_buffer[MAX_BUFFER];
    int sock;
    
    host_info = gethostbyname(server_host);
    if (!host_info) {
        perror("DNS resolution failed");
        return NULL;
    }

    memset(&server_addr, 0, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(HTTP_PORT);
    memcpy(&server_addr.sin_addr, host_info->h_addr, host_info->h_length);

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0) {
        perror("Socket creation failed");
        return NULL;
    }

    if (connect(sock, (struct sockaddr *)&server_addr, sizeof(server_addr)) < 0) {
        perror("Connection failed");
        close(sock);
        return NULL;
    }

    snprintf(request_buffer, sizeof(request_buffer), REQUEST, server_host, user_agents[rand() % 4]);

    send(sock, request_buffer, strlen(request_buffer), 0);

    recv(sock, response_buffer, sizeof(response_buffer) - 1, 0);
    printf("Response received from %s\n", server_host);

    close(sock);
    return NULL;
}

int main(int argc, char *argv[]) {
    if (argc < 3) {
        printf("Usage: %s <URL> <threads (max %d)>\n", argv[0], MAX_THREADS);
        exit(EXIT_FAILURE);
    }

    char *server_host = argv[1];
    int num_threads = atoi(argv[2]);

    if (num_threads > MAX_THREADS) {
        printf("Too many threads! Limiting to %d.\n", MAX_THREADS);
        num_threads = MAX_THREADS;
    }

    pthread_t threads[num_threads];

    for (int i = 0; i < num_threads; i++) {
        pthread_create(&threads[i], NULL, http_request, (void *)server_host);
    }

    for (int i = 0; i < num_threads; i++) {
        pthread_join(threads[i], NULL);
    }

    printf("All requests completed.\n");
    return 0;
}
