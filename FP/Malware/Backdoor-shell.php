<?php
class SafeFileManager {
   var $pwd;
   var $rep;
   var $list = array();
   var $file;

   function dir() {
      $directory = !empty($this->rep) ? $this->rep : $this->pwd;
      if (is_dir($directory)) {
         $dir = opendir($directory);
         while ($f = readdir($dir)) {
            if ($f != "." && $f != "..") {
               $this->list[] = $f;
            }
         }
         closedir($dir);
      }
   }

   function view() {
      if (file_exists($this->file) && is_readable($this->file)) {
         echo "<pre>" . htmlentities(file_get_contents($this->file)) . "</pre>";
      } else {
         echo "Error: File not found or unreadable.";
      }
   }
}

$rep = isset($_REQUEST['rep']) ? realpath($_REQUEST['rep']) . "/" : "";
$file = isset($_REQUEST['file']) ? realpath($_REQUEST['file']) : "";

$pwd = dirname(__FILE__);

echo "<html><head><title>Safe File Manager</title></head><body>";
echo "<h2>Directory Listing for: " . htmlentities($pwd) . "</h2>";

$fileManager = new SafeFileManager();
$fileManager->pwd = $pwd;
$fileManager->rep = $rep;
$fileManager->file = $file;
$fileManager->dir();

echo "<pre>";
echo "[DIR] <a href='" . $_SERVER['PHP_SELF'] . "?rep=" . htmlentities(realpath($rep . "../")) . "'>Parent Directory</a>\n";
foreach ($fileManager->list as $key => $value) {
   $fullPath = $rep . $value;
   if (is_dir($fullPath)) {
      echo "[DIR] <a href='" . $_SERVER['PHP_SELF'] . "?rep=" . htmlentities($fullPath) . "'>" . htmlentities($value) . "/</a>\n";
   } else {
      echo "[FILE] <a href='" . $_SERVER['PHP_SELF'] . "?file=" . htmlentities($fullPath) . "'>" . htmlentities($value) . "</a>\n";
   }
}
echo "</pre>";

if ($file) {
   $fileManager->view();
}

echo "</body></html>";
?>
