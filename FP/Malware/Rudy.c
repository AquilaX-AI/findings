#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <pthread.h>
#include <curl/curl.h>
#include <unistd.h>

#define MAX_THREADS 5

typedef struct {
    char target_url[256];
    int num_requests;
    int delay; // in milliseconds
} check_params_t;

void *check_website(void *args) {
    check_params_t *params = (check_params_t *)args;
    CURL *curl;
    CURLcode res;

    printf("[Thread] Checking: %s | %d requests | %dms delay\n", params->target_url, params->num_requests, params->delay);

    curl_global_init(CURL_GLOBAL_ALL);
    curl = curl_easy_init();

    if (curl) {
        for (int i = 0; i < params->num_requests; i++) {
            curl_easy_setopt(curl, CURLOPT_URL, params->target_url);
            curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1L);
            curl_easy_setopt(curl, CURLOPT_USERAGENT, "WebsiteChecker/1.0");

            res = curl_easy_perform(curl);
            if (res == CURLE_OK) {
                long http_code = 0;
                curl_easy_getinfo(curl, CURLINFO_RESPONSE_CODE, &http_code);
                printf("[Response] %s returned HTTP %ld\n", params->target_url, http_code);
            } else {
                fprintf(stderr, "[Error] Failed to reach %s: %s\n", params->target_url, curl_easy_strerror(res));
            }

            usleep(params->delay * 1000);
        }
    }

    curl_easy_cleanup(curl);
    curl_global_cleanup();
    free(params);
    return NULL;
}

int main(int argc, char *argv[]) {
    if (argc < 4) {
        printf("Usage: %s <target URL> <number of requests> <delay in ms>\n", argv[0]);
        return EXIT_FAILURE;
    }

    char target_url[256];
    int num_requests = atoi(argv[2]);
    int delay = atoi(argv[3]);

    if (num_requests <= 0 || delay < 0) {
        printf("Invalid parameters. Please enter a valid number of requests and delay.\n");
        return EXIT_FAILURE;
    }

    strncpy(target_url, argv[1], 255);
    target_url[255] = '\0';

    pthread_t threads[MAX_THREADS];

    printf("Checking website availability: %s\n", target_url);

    for (int i = 0; i < MAX_THREADS; i++) {
        check_params_t *params = malloc(sizeof(check_params_t));
        if (!params) {
            perror("Memory allocation failed");
            return EXIT_FAILURE;
        }

        strncpy(params->target_url, target_url, 256);
        params->num_requests = num_requests;
        params->delay = delay;

        pthread_create(&threads[i], NULL, check_website, params);
        usleep(100000); // Small delay between thread creation
    }

    for (int i = 0; i < MAX_THREADS; i++) {
        pthread_join(threads[i], NULL);
    }

    printf("Website check completed.\n");
    return EXIT_SUCCESS;
}
