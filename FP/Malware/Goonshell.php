<?php
session_start();
error_reporting(E_ALL);

$users = [
    "admin" => password_hash("P@ssword123", PASSWORD_BCRYPT),
];

function check_auth() {
    if (!isset($_SESSION['user'])) {
        header("Location: login.php");
        exit();
    }
}

function login($username, $password) {
    global $users;
    if (isset($users[$username]) && password_verify($password, $users[$username])) {
        $_SESSION['user'] = $username;
        return true;
    }
    return false;
}

function logout() {
    session_destroy();
    header("Location: login.php");
}

function sanitize_path($path) {
    return realpath(__DIR__ . '/' . trim($path, '/'));
}

function list_files($dir) {
    $dir = sanitize_path($dir);
    if (!$dir || !is_dir($dir)) {
        return [];
    }
    return array_diff(scandir($dir), ['.', '..']);
}

function view_file($file) {
    $file = sanitize_path($file);
    if (is_file($file) && is_readable($file)) {
        return htmlspecialchars(file_get_contents($file));
    }
    return "Error: File cannot be read.";
}

function delete_file($file) {
    check_auth();
    $file = sanitize_path($file);
    if (is_file($file) && is_writable($file)) {
        unlink($file);
        return "File deleted successfully.";
    }
    return "Error: Cannot delete file.";
}

function upload_file($target_dir) {
    check_auth();
    $target_dir = sanitize_path($target_dir);
    
    if (!isset($_FILES['file']) || $_FILES['file']['error'] !== UPLOAD_ERR_OK) {
        return "Upload error.";
    }
    
    $filename = basename($_FILES['file']['name']);
    $target_file = $target_dir . "/" . $filename;

    $allowed_types = ['jpg', 'png', 'txt', 'pdf'];
    $file_ext = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));

    if (!in_array($file_ext, $allowed_types)) {
        return "Invalid file type.";
    }

    if (move_uploaded_file($_FILES['file']['tmp_name'], $target_file)) {
        return "File uploaded successfully.";
    }

    return "Upload failed.";
}

function execute_command($cmd) {
    return "Command execution is disabled for security.";
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['login'])) {
        if (login($_POST['username'], $_POST['password'])) {
            header("Location: index.php");
            exit();
        } else {
            echo "Invalid credentials!";
        }
    }
    
    if (isset($_POST['logout'])) {
        logout();
    }
}

?>
