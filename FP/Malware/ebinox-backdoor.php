<?php
session_start();

const USERNAME = 'admin'; 
const PASSWORD = 'password'; 

if (!isset($_SESSION['authenticated']) && basename($_SERVER['PHP_SELF']) !== 'login.php') {
    header('Location: login.php');
    exit;
}

$allowed_extensions = ['txt', 'jpg', 'png', 'pdf'];
$upload_dir = __DIR__ . '/uploads/';
if (!is_dir($upload_dir)) mkdir($upload_dir, 0755, true);

function listFiles($dir)
{
    $files = array_diff(scandir($dir), ['.', '..']);
    return $files;
}

function sanitizeFilename($filename)
{
    return preg_replace('/[^a-zA-Z0-9._-]/', '_', basename($filename));
}

if (isset($_FILES['file'])) {
    $filename = sanitizeFilename($_FILES['file']['name']);
    $file_ext = pathinfo($filename, PATHINFO_EXTENSION);
    
    if (!in_array($file_ext, $allowed_extensions)) {
        echo "Invalid file type.";
    } else {
        move_uploaded_file($_FILES['file']['tmp_name'], $upload_dir . $filename);
        echo "File uploaded successfully.";
    }
}

if (isset($_POST['delete_file'])) {
    $file = $upload_dir . sanitizeFilename($_POST['delete_file']);
    if (is_file($file)) {
        unlink($file);
        echo "File deleted successfully.";
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager</title>
</head>
<body>
    <h2>File Manager</h2>
    
    <h3>Upload File</h3>
    <form action="" method="post" enctype="multipart/form-data">
        <input type="file" name="file" required>
        <button type="submit">Upload</button>
    </form>
    
    <h3>Uploaded Files</h3>
    <ul>
        <?php foreach (listFiles($upload_dir) as $file): ?>
            <li>
                <?= htmlspecialchars($file) ?>
                <form method="post" style="display:inline;">
                    <input type="hidden" name="delete_file" value="<?= htmlspecialchars($file) ?>">
                    <button type="submit">Delete</button>
                </form>
            </li>
        <?php endforeach; ?>
    </ul>
</body>
</html>
