#include <pthread.h>
#include <time.h>
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <netinet/ip.h>
#include <netinet/udp.h>
#include <arpa/inet.h>

#define MAX_PACKET_SIZE 512 
#define MAX_THREADS 10     
#define MAX_TESTS 5           
#define TIMEOUT_SEC 2        

struct thread_data {
    int thread_id;
    struct sockaddr_in sin;
};

void *udp_test(void *par1) {
    struct thread_data *td = (struct thread_data *)par1;
    int sock;
    char buffer[MAX_PACKET_SIZE] = "PING"; // Simple ping message
    struct timeval timeout = {TIMEOUT_SEC, 0};

    sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);
    if (sock < 0) {
        perror("Socket creation failed");
        return NULL;
    }

    setsockopt(sock, SOL_SOCKET, SO_RCVTIMEO, &timeout, sizeof(timeout));

    printf("[Thread %d] Testing UDP connectivity to %s:%d\n", 
           td->thread_id, inet_ntoa(td->sin.sin_addr), ntohs(td->sin.sin_port));

    for (int i = 0; i < MAX_TESTS; i++) {
        // Send UDP test packet
        sendto(sock, buffer, strlen(buffer), 0, 
               (struct sockaddr *)&td->sin, sizeof(td->sin));

        char response[MAX_PACKET_SIZE];
        struct sockaddr_in from;
        socklen_t fromlen = sizeof(from);
        int bytes_received = recvfrom(sock, response, MAX_PACKET_SIZE, 0, 
                                      (struct sockaddr *)&from, &fromlen);

        if (bytes_received > 0) {
            printf("[Thread %d] Response received from %s:%d -> %s\n",
                   td->thread_id, inet_ntoa(from.sin_addr), ntohs(from.sin_port), response);
        } else {
            printf("[Thread %d] No response from %s:%d\n", 
                   td->thread_id, inet_ntoa(td->sin.sin_addr), ntohs(td->sin.sin_port));
        }

        sleep(1); // Prevent spam
    }

    close(sock);
    return NULL;
}

int main(int argc, char *argv[]) {
    if (argc < 4) {
        printf("Usage: %s <target IP> <target port> <threads (max %d)>\n", argv[0], MAX_THREADS);
        exit(EXIT_FAILURE);
    }

    char *target_ip = argv[1];
    int target_port = atoi(argv[2]);
    int num_threads = atoi(argv[3]);

    if (num_threads > MAX_THREADS) {
        printf("Too many threads! Limiting to %d.\n", MAX_THREADS);
        num_threads = MAX_THREADS;
    }

    pthread_t threads[num_threads];
    struct thread_data td[num_threads];

    struct sockaddr_in sin;
    sin.sin_family = AF_INET;
    sin.sin_port = htons(target_port);
    sin.sin_addr.s_addr = inet_addr(target_ip);

    for (int i = 0; i < num_threads; i++) {
        td[i].thread_id = i;
        td[i].sin = sin;
        pthread_create(&threads[i], NULL, &udp_test, (void *)&td[i]);
    }

    for (int i = 0; i < num_threads; i++) {
        pthread_join(threads[i], NULL);
    }

    printf("All tests completed.\n");
    return 0;
}
