<?php
session_start();

define('VERSION', '2.0');
define('AUTH_USER', 'admin'); 
define('AUTH_PASS', 'password'); 

if (!isset($_SESSION['auth'])) {
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['username'], $_POST['password'])) {
        if ($_POST['username'] === AUTH_USER && $_POST['password'] === AUTH_PASS) {
            $_SESSION['auth'] = true;
            header("Location: {$_SERVER['PHP_SELF']}");
            exit;
        } else {
            $error = "Invalid credentials!";
        }
    }
    ?>
    <form method="post">
        <h2>Login</h2>
        <?php if (isset($error)) echo "<p style='color:red;'>$error</p>"; ?>
        <input type="text" name="username" placeholder="Username" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit">Login</button>
    </form>
    <?php
    exit;
}

// Log out
if (isset($_GET['logout'])) {
    session_destroy();
    header("Location: {$_SERVER['PHP_SELF']}");
    exit;
}

// Secure file operations
function safe_path($path) {
    return realpath($path) ?: die("Invalid Path");
}

$dir = isset($_GET['dir']) ? safe_path($_GET['dir']) : getcwd();

// Display files
function list_files($dir) {
    if (!is_dir($dir)) die("Not a directory");
    echo "<h3>Current Directory: " . htmlspecialchars($dir) . "</h3>";
    echo "<a href='?logout=1'>Logout</a><br>";

    // Back link
    if (dirname($dir) !== $dir) {
        echo "<a href='?dir=" . urlencode(dirname($dir)) . "'>Go Up</a><br>";
    }

    // List files
    foreach (scandir($dir) as $file) {
        if ($file === "." || $file === "..") continue;
        $path = realpath("$dir/$file");
        echo "<a href='?dir=" . urlencode($path) . "'>" . htmlspecialchars($file) . "</a><br>";
    }
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['file'])) {
    $upload_dir = $dir;
    $upload_file = $upload_dir . '/' . basename($_FILES['file']['name']);

    // Restrict file types
    $allowed_exts = ['txt', 'jpg', 'png', 'log'];
    $file_ext = pathinfo($upload_file, PATHINFO_EXTENSION);
    
    if (!in_array($file_ext, $allowed_exts)) {
        die("Invalid file type!");
    }

    if (move_uploaded_file($_FILES['file']['tmp_name'], $upload_file)) {
        echo "File uploaded successfully!";
    } else {
        echo "Upload failed!";
    }
}

list_files($dir);
?>

<h2>Upload File</h2>
<form method="post" enctype="multipart/form-data">
    <input type="file" name="file" required>
    <button type="submit">Upload</button>
</form>
