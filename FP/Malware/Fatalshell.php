<?php
session_start();

$USERNAME = 'administrator';
$PASSWORD = 'secure';

if (!isset($_SESSION['authenticated'])) {
    if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['username']) && isset($_POST['password'])) {
        if ($_POST['username'] === $USERNAME && $_POST['password'] === $PASSWORD) {
            $_SESSION['authenticated'] = true;
        } else {
            echo "<p style='color: red;'>Invalid credentials.</p>";
        }
    }
    if (!isset($_SESSION['authenticated'])) {
        echo '<form method="POST">
                <label>Username:</label> <input type="text" name="username" required>
                <label>Password:</label> <input type="password" name="password" required>
                <input type="submit" value="Login">
              </form>';
        exit;
    }
}

$directory = isset($_GET['dir']) ? realpath($_GET['dir']) : getcwd();
if (!is_dir($directory)) {
    $directory = getcwd();
}

if (strpos($directory, getcwd()) !== 0) {
    $directory = getcwd();
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['file'])) {
    $allowed_extensions = ['txt', 'jpg', 'png', 'pdf'];
    $file_info = pathinfo($_FILES['file']['name']);
    if (in_array(strtolower($file_info['extension']), $allowed_extensions)) {
        move_uploaded_file($_FILES['file']['tmp_name'], "$directory/{$_FILES['file']['name']}");
        echo "<p style='color: green;'>File uploaded successfully!</p>";
    } else {
        echo "<p style='color: red;'>Invalid file type.</p>";
    }
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['delete'])) {
    $file_to_delete = realpath($directory . '/' . $_POST['delete']);
    if ($file_to_delete && strpos($file_to_delete, $directory) === 0 && is_file($file_to_delete)) {
        unlink($file_to_delete);
        echo "<p style='color: green;'>File deleted successfully!</p>";
    } else {
        echo "<p style='color: red;'>File deletion failed.</p>";
    }
}

$files = scandir($directory);
echo "<h2>Secure File Manager</h2>";
echo "<p>Current Directory: $directory</p>";
echo "<ul>";
foreach ($files as $file) {
    if ($file === '.' || $file === '..') continue;
    $file_path = "$directory/$file";
    if (is_dir($file_path)) {
        echo "<li><a href='?dir=$file_path'>$file</a></li>";
    } else {
        echo "<li>$file - <form style='display:inline;' method='POST'>
                <input type='hidden' name='delete' value='$file'>
                <input type='submit' value='Delete'>
              </form>
              </li>";
    }
}
echo "</ul>";

echo "<form method='POST' enctype='multipart/form-data'>
        <input type='file' name='file' required>
        <input type='submit' value='Upload'>
      </form>";

echo "<form method='POST' action='logout.php'>
        <input type='submit' value='Logout'>
      </form>";
?>
